#include <stdint.h>
#include "activation.h"
#include "minmax.h"
// Q15 of tanh, dtanh
int16_t coeffs_tanh[] = {0x01ff,0x7ff8,0x05fe,0x7fb8,0x09fa,0x7f38,0x0df1,0x7e7b,0x11e1,0x7d80,0x15c9,0x7c4a,0x19a5,0x7adc,0x1d76,0x7937,0x2138,0x7760,0x24eb,0x7559,0x288e,0x7326,0x2c1d,0x70cb,0x2f9a,0x6e4b,0x3302,0x6bac,0x3654,0x68f0,0x3991,0x661c,0x3cb6,0x6333,0x3fc4,0x603b,0x42ba,0x5d37,0x4597,0x5a29,0x485c,0x5717,0x4b08,0x5403,0x4d9c,0x50f0,0x5018,0x4de1,0x527a,0x4ad9,0x54c5,0x47db,0x56f8,0x44e7,0x5914,0x4201,0x5b19,0x3f2a,0x5d07,0x3c63,0x5edf,0x39ae,0x60a2,0x370b,0x6250,0x347c,0x63ea,0x3201,0x6570,0x2f9b,0x66e4,0x2d4a,0x6845,0x2b0e,0x6995,0x28e8,0x6ad4,0x26d6,0x6c03,0x24da,0x6d22,0x22f3,0x6e32,0x2121,0x6f34,0x1f62,0x7028,0x1db8,0x7110,0x1c21,0x71eb,0x1a9d,0x72ba,0x192b,0x737e,0x17cb,0x7437,0x167b,0x74e5,0x153d,0x758b,0x140f,0x7627,0x12ef,0x76ba,0x11df,0x7745,0x10dd,0x77c8,0x0fe8,0x7843,0x0f00,0x78b8,0x0e25,0x7926,0x0d55,0x798d,0x0c91,0x79ef,0x0bd7,0x7a4b,0x0b27,0x7aa2,0x0a82,0x7af3,0x09e5,0x7b40,0x0951,0x7b88,0x08c6,0x7bcd,0x0842,0x7c0d,0x07c6,0x7c49,0x0751,0x7c82,0x06e3,0x7cb7,0x067a,0x7cea,0x0618,0x7d19,0x05bc,0x7d45,0x0565,0x7d6f,0x0513,0x7d97,0x04c6,0x7dbc,0x047d,0x7ddf,0x0438,0x7dff,0x03f8,0x7e1e,0x03bb,0x7e3b,0x0382,0x7e56,0x034c,0x7e70,0x031a,0x7e88,0x02ea,0x7e9f,0x02be,0x7eb4,0x0293,0x7ec8,0x026c,0x7edb,0x0247,0x7eec,0x0224,0x7efd,0x0203,0x7f0d,0x01e4,0x7f1b,0x01c6,0x7f29,0x01ab,0x7f36,0x0191,0x7f42,0x0179,0x7f4e,0x0162,0x7f58,0x014d,0x7f62,0x0139,0x7f6c,0x0126,0x7f75,0x0114,0x7f7d,0x0104,0x7f85,0x00f4,0x7f8d,0x00e5,0x7f93,0x00d7,0x7f9a,0x00ca,0x7fa0,0x00be,0x7fa6,0x00b2,0x7fab,0x00a8,0x7fb0,0x009d,0x7fb5,0x0094,0x7fba,0x008b,0x7fbe,0x0083,0x7fc2,0x007b,0x7fc6,0x0073,0x7fc9,0x006c,0x7fcc,0x0066,0x7fd0,0x005f,0x7fd2,0x005a,0x7fd5,0x0054,0x7fd8,0x004f,0x7fda,0x004a,0x7fdc,0x0046,0x7fdf,0x0041,0x7fe1,0x003d,0x7fe2,0x003a,0x7fe4,0x0036,0x7fe6,0x0033,0x7fe7,0x0030,0x7fe9,0x002d,0x7fea,0x002a,0x7feb,0x0028,0x7fed,0x0025,0x7fee,0x0023,0x7fef,0x0021,0x7ff0,0x001f,0x7ff1,0x001d,0x7ff2,0x001b,0x7ff3,0x0019,0x7ff3,0x0018,0x7ff4,0x0016,0x7ff5,0x0015,0x7ff5,0x0014,0x7ff6,0x0012,0x7ff7,0x0011,0x7ff7,0x0010,0x7ff8,0x000f,0x7ff8,0x000e,0x7ff9,0x000d,0x7ff9,0x000c,0x7ff9,0x000c,0x7ffa,0x000b,0x7ffa,0x000a,0x7ffa,0x000a,0x7ffb,0x0009,0x7ffb,0x0008,0x7ffb,0x0008,0x7ffc,0x0007,0x7ffc,0x0007,0x7ffc,0x0006,0x7ffc,0x0006,0x7ffc,0x0006,0x7ffd,0x0005,0x7ffd,0x0005,0x7ffd,0x0005,0x7ffd,0x0004,0x7ffd,0x0004,0x7ffd,0x0004,0x7ffe,0x0003,0x7ffe,0x0003,0x7ffe,0x0003,0x7ffe,0x0003,0x7ffe,0x0003,0x7ffe,0x0002,0x7ffe,0x0002,0x7ffe,0x0002,0x7ffe,0x0002,0x7ffe,0x0002,0x7ffe,0x0002,0x7fff,0x0001,0x7fff,0x0001,0x7fff,0x0001,0x7fff,0x0001,0x7fff,0x0001,0x7fff,0x0001,0x7fff,0x0001,0x7fff,0x0001,0x7fff,0x0001,0x7fff,0x0001,0x7fff,0x0001,0x7fff,0x0001,0x7fff,0x0000,0x7fff,0x0000,0x7fff,0x0000,};
void* relu6_fix(	int16_t* y, // Q12
					int32_t* x, // Q15
					int len)
{
	int i;
	int32_t th = ((int32_t) 6 << 12);
	for (i = 0; i < len; i++)
	{
		y[i] = (int16_t) MAX(MIN(th, x[i] >> 3), 0);
	}
	return (void*) (y+len);
}

void* linear_fix(int32_t* y, // Q15
				 int32_t* x, // Q15
				 int len)
{
	int i;
	for (i = 0; i < len; i++)
	{
		y[i] = x[i];
	}
	return (void*)(y + len);
}

void* tanh_fix(int16_t* y, int32_t* x, int len)
{
	int32_t d = (int32_t) 1 << 10; // 2^-5
	int32_t s = d >> 1; // 2^-6
	int32_t M = (int32_t)5 << 15;
	int32_t kx;
	int32_t dx;
	int32_t xi;
	int8_t is_neg;
	int i;
	for (i = 0; i < len; i++)
	{
		
		if (x[i] < 0)
		{
			is_neg = 1;
			xi = -x[i];
		}
		else
		{
			is_neg = 0;
			xi = x[i];
		}
		if (xi >= M)
			y[i] = 0x7fff;
		else
		{
			kx = MAX((xi - s) >> 10, 0);
			dx = xi - s - (kx << 10);
			dx = (int32_t)coeffs_tanh[(kx<<1)] + ((dx * (int32_t)coeffs_tanh[(kx<<1) + 1]) >> 15);
			y[i] = (int16_t)MAX(dx, 0);
		}
		if (is_neg)
			y[i] = -y[i];

		
	}
	return (void*)(y + len);
}

// σ(x) = (tanh(x/2) + 1) / 2
void* sigmoid_fix(int16_t* y, int32_t* x, int len)
{
	int32_t h = (int32_t) 1 << 14;
	int i;
	int32_t xi;
	for (i = 0; i < len; i++)
	{
		xi = x[i] >> 1;
		tanh_fix(&y[i], &xi, 1);
		y[i] >>= 1;
		y[i] += h;
	}

	return (void*)(y + len);
}

